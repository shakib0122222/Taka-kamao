<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Taka Income Pro</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700;800&display=swap');
        :root { 
            --primary-color: #ff6347; 
            --primary-color-rgb: 255, 99, 71; 
            --secondary-color: #e5533d; 
            --background-color: #F0F2F5; 
            --card-background: #FFFFFF; 
            --text-color: #1D1D1F; 
            --text-light: #6E6E73; 
            --border-color: #E5E5EA; 
            --glass-bg: rgba(240, 242, 245, 0.8); 
            --tomato-gradient: linear-gradient(135deg, #ff6347, #e5533d, #d43f2a);
        }
        [data-theme="dark"] { 
            --primary-color: #ff6347; 
            --primary-color-rgb: 255, 99, 71; 
            --secondary-color: #e5533d;
            --background-color: #000000; 
            --card-background: #1C1C1E; 
            --text-color: #F5F5F7; 
            --text-light: #8E8E93; 
            --border-color: #3A3A3C; 
            --glass-bg: rgba(28, 28, 30, 0.8); 
            --tomato-gradient: linear-gradient(135deg, #ff6347, #e5533d, #d43f2a);
        }
        
        * { box-sizing: border-box; }
        body { font-family: 'Noto Sans', sans-serif; margin: 0; padding: 20px 15px 100px 15px; background: var(--tomato-gradient), var(--background-color); background-size: cover; background-blend-mode: overlay; color: var(--text-color); transition: all 0.3s; }
        
        #preloader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; background: var(--tomato-gradient), var(--background-color); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; }
        #preloader i { font-size: 48px; color: var(--primary-color); animation: spin 1.5s linear infinite; }
        #preloader-percentage { font-size: 20px; font-weight: 700; color: var(--text-color); }

        .container { max-width: 500px; margin: 0 auto; display: none; }
        .profile-header { display: flex; align-items: center; gap: 15px; margin-bottom: 24px; position: relative; }
        #profile-pic { width: 52px; height: 52px; border-radius: 50%; background: var(--tomato-gradient); display: flex; align-items: center; justify-content: center; font-size: 26px; font-weight: 700; overflow: hidden; border: 2px solid var(--card-background); color: white; position: relative; }
        #profile-pic img { width: 100%; height: 100%; object-fit: cover; }
        #greeting { font-size: 22px; font-weight: 800; }

        .balance-card { background: var(--tomato-gradient); color: white; padding: 28px; border-radius: 24px; text-align: center; margin-bottom: 20px; box-shadow: 0 12px 25px rgba(var(--primary-color-rgb), 0.3); }
        .balance-card .amount { font-size: 48px; font-weight: 800; }

        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 20px; }
        .stat-item { background: var(--card-background); padding: 20px; border-radius: 18px; text-align: center; border: 1px solid var(--border-color); opacity: 0.95; }
        .stat-item .value { font-size: 24px; font-weight: 800; }

        .card { background: var(--card-background); padding: 20px; border-radius: 18px; margin-bottom: 20px; border: 1px solid var(--border-color); opacity: 0.95; }
        .card-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; }

        .action-button { display: flex; align-items: center; justify-content: center; gap: 12px; width: 100%; padding: 18px; border: none; border-radius: 16px; background: var(--tomato-gradient); color: white; font-size: 18px; font-weight: 700; cursor: pointer; }
        .action-button:disabled { background: #8E8E93; cursor: not-allowed; }

        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; max-width: 500px; margin: 0 auto; display: grid; grid-template-columns: repeat(5, 1fr); padding: 10px 15px; background: var(--glass-bg); backdrop-filter: blur(10px); border-top: 1px solid var(--border-color); z-index: 100; }
        .nav-button { display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 8px; color: var(--text-light); font-size: 12px; font-weight: 500; background: transparent; border: none; cursor: near; }
        .nav-button.active, .nav-button:hover { color: var(--primary-color); }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background: var(--card-background); padding: 24px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; }
        .close-button { float: right; font-size: 28px; cursor: pointer; }

        .vip-badge-on-pic { position: absolute; bottom: 0; right: 0; background: #000; border-radius: 50%; padding: 2px; }
        .vip-badge-on-pic img { width: 20px; height: 20px; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spinner { border: 2px solid #f3f3f3; border-top: 2px solid var(--secondary-color); border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; display: none; }
    </style>
</head>
<body>
    <div id="preloader">
        <i class="fa-solid fa-spinner"></i>
        <div id="preloader-percentage">0%</div>
    </div>

    <div class="container">
        <div class="profile-header">
            <div id="profile-pic"><i class="fa-solid fa-user"></i></div>
            <h1 id="greeting">Welcome!</h1>
            <div id="vip-badge-container" style="display: none; margin-left: auto;">
                <span style="background: linear-gradient(45deg, #FFD700, #FFA500); color: #000; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 700;">
                    <i class="fa-solid fa-crown"></i> VIP
                </span>
            </div>
        </div>

        <div class="balance-card">
            <h3>Your Balance</h3>
            <div class="amount" id="total-earning">৳0.00</div>
        </div>

        <div class="stats-grid">
            <div class="stat-item">
                <div class="value" id="ad-count">0</div>
                <div class="label">Ads Watched</div>
            </div>
            <div class="stat-item">
                <div class="value" id="ads-today-count">0 / 15</div>
                <div class="label">Today's Ads</div>
            </div>
            <div class="stat-item">
                <div class="value" id="referral-count">0</div>
                <div class="label">Referrals</div>
            </div>
        </div>

        <!-- VIP SECTION (Admin Controlled) -->
        <div id="vipSection" class="card" style="border: 2px solid #FFD700; background: linear-gradient(135deg, #FFD700, #FFA500);">
            <h3 class="card-title" style="color: #000; display: flex; align-items: center; gap: 8px;">
                <img src="https://i.ibb.co.com/3d3yY9K/vip-crown.gif" alt="VIP" style="width: 28px; height: 28px;"> VIP Membership
            </h3>
            <div id="vip-packages-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                <!-- Loaded from Firebase -->
            </div>
            <button class="action-button" id="buy-vip-button" style="background: #000; color: #FFD700; font-weight: 800;">
                <i class="fa-solid fa-crown"></i> Buy VIP Now
            </button>
        </div>

        <div class="card">
            <h3 class="card-title">Today's Task</h3>
            <button class="action-button" id="watch-ad-button"><i class="fa-solid fa-play"></i> Watch Ad</button>
        </div>
    </div>

    <!-- VIP Purchase Modal -->
    <div id="vipPurchaseModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('vipPurchaseModal')">&times;</span>
            <h3 style="color: #FFD700; display: flex; align-items: center; gap: 8px;">
                <img src="https://i.ibb.co.com/3d3yY9K/vip-crown.gif" alt="VIP" style="width: 32px; height: 32px;"> Buy VIP
            </h3>
            <div style="background: #000; color: #FFD700; padding: 15px; border-radius: 12px; text-align: left; font-weight: 600;">
                <p><strong>Send To:</strong> <code style="background: #333; color: #FFD700; padding: 4px 8px; border-radius: 6px;">01925723245</code>
                    <button onclick="copyPaymentNumber()" style="margin-left: 8px; padding: 4px 8px; font-size: 12px; background: #FFD700; color: #000; border: none; border-radius: 6px; font-weight: 700;">Copy</button>
                </p>
                <p><strong>Method:</strong> Bkash / Nagad</p>
            </div>
            <form id="vip-request-form">
                <select id="vip-package-select" required style="margin: 12px 0; padding: 12px; width: 100%; border-radius: 8px;"></select>
                <input type="text" id="transaction-id" placeholder="Transaction ID" required>
                <input type="text" id="user-tg-id" placeholder="Your TG ID" readonly>
                <button type="submit" class="action-button" style="background: #000; color: #FFD700; margin-top: 15px;">
                    <span>Send Request</span>
                    <div class="spinner"></div>
                </button>
            </form>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const config = {
            BOT_TOKEN: '8592541498:AAHn5vYf8qlMuVrBt_OIbR8VhdG0gGO3vOA',
            ADMIN_IDS: [7731349577],
            firebase: {
                apiKey: "AIzaSyCWvaqpi3LvNDeZpDBunnDwU392ZH_FY8M",
                authDomain: "st-project-taka-kamao.firebaseapp.com",
                databaseURL: "https://st-project-taka-kamao-default-rtdb.firebaseio.com",
                projectId: "st-project-taka-kamao",
                storageBucket: "st-project-taka-kamao.firebasestorage.app",
                messagingSenderId: "151575920757",
                appId: "1:151575920757:web:5dc8e0e2a0856f5a76b83c"
            }
        };

        const tg = window.Telegram.WebApp;
        let db, state = { totalEarning: 0, adCount: 0, adsWatchedToday: 0, vip: { active: false, dailyLimit: 15 } };
        let vipPackages = [];

        // --- INIT FIREBASE ---
        firebase.initializeApp(config.firebase);
        db = firebase.database();

        // --- DOM ---
        const els = {
            totalEarning: document.getElementById('total-earning'),
            adCount: document.getElementById('ad-count'),
            adsTodayCount: document.getElementById('ads-today-count'),
            buyVipBtn: document.getElementById('buy-vip-button'),
            vipBadge: document.getElementById('vip-badge-container'),
            profilePic: document.getElementById('profile-pic'),
            vipPackagesContainer: document.getElementById('vip-packages-container'),
            vipSelect: document.getElementById('vip-package-select'),
            userTgId: document.getElementById('user-tg-id')
        };

        // --- LOAD VIP PACKAGES ---
        function loadVipPackages() {
            db.ref('admin/vip_packages').on('value', snap => {
                vipPackages = Object.values(snap.val() || {});
                renderVipPackages();
                renderVipSelect();
            });
        }

        function renderVipPackages() {
            els.vipPackagesContainer.innerHTML = '';
            vipPackages.forEach(p => {
                const div = document.createElement('div');
                div.className = 'stat-item';
                div.innerHTML = `<div class="value" style="font-size:20px;color:#000;">৳${p.price}</div><div class="label">${p.ads} Ads/Day</div><div class="label" style="font-size:12px;color:#555;">${p.days} Days</div>`;
                els.vipPackagesContainer.appendChild(div);
            });
        }

        function renderVipSelect() {
            els.vipSelect.innerHTML = '<option value="">Select Package</option>';
            vipPackages.forEach(p => {
                const opt = document.createElement('option');
                opt.value = `${p.price}_${p.ads}_${p.days}`;
                opt.textContent = `৳${p.price} - ${p.ads} Ads/Day (${p.days} Days)`;
                els.vipSelect.appendChild(opt);
            });
        }

        // --- VIP STATUS ---
        function updateVIPStatus() {
            const userId = tg.initDataUnsafe.user.id;
            db.ref(`vip/${userId}`).on('value', snap => {
                const vip = snap.val();
                if (vip && vip.active && new Date(vip.expiresAt) > new Date()) {
                    state.vip = vip;
                    els.adsTodayCount.textContent = `${state.adsWatchedToday} / ${vip.dailyLimit}`;
                    els.buyVipBtn.textContent = 'VIP Active';
                    els.buyVipBtn.disabled = true;
                    els.vipBadge.style.display = 'block';
                    addVipBadgeToPic();
                } else {
                    state.vip = { active: false, dailyLimit: 15 };
                    els.adsTodayCount.textContent = `${state.adsWatchedToday} / 15`;
                    els.buyVipBtn.textContent = 'Buy VIP Now';
                    els.buyVipBtn.disabled = false;
                    els.vipBadge.style.display = 'none';
                    removeVipBadgeFromPic();
                }
            });
        }

        function addVipBadgeToPic() {
            if (document.getElementById('vip-badge-on-pic')) return;
            const badge = document.createElement('div');
            badge.id = 'vip-badge-on-pic';
            badge.className = 'vip-badge-on-pic';
            badge.innerHTML = '<img src="https://i.ibb.co.com/3d3yY9K/vip-crown.gif" alt="VIP">';
            els.profilePic.appendChild(badge);
        }

        function removeVipBadgeFromPic() {
            const badge = document.getElementById('vip-badge-on-pic');
            if (badge) badge.remove();
        }

        // --- VIP PURCHASE ---
        document.getElementById('vip-request-form').addEventListener('submit', async e => {
            e.preventDefault();
            const pkg = els.vipSelect.value;
            const txid = document.getElementById('transaction-id').value.trim();
            const user = tg.initDataUnsafe.user;
            if (!pkg || !txid) return alert('Fill all fields!');

            const [price, ads, days] = pkg.split('_');
            const req = { userId: user.id, username: user.username || 'N/A', first_name: user.first_name, package: `${price} BDT - ${ads} Ads/Day (${days} Days)`, txid, price: +price, ads: +ads, days: +days, requestedAt: new Date().toISOString(), status: 'pending' };

            const btn = e.target.querySelector('button');
            btn.querySelector('span').style.display = 'none';
            btn.querySelector('.spinner').style.display = 'inline-block';
            btn.disabled = true;

            try {
                await db.ref(`vip_requests/${user.id}_${Date.now()}`).set(req);
                await fetch(`https://api.telegram.org/bot${config.BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_id: config.ADMIN_IDS[0], text: `<b>NEW VIP REQUEST</b>\nUser: ${req.first_name} (@${req.username})\nPackage: ${req.package}\nTxID: <code>${txid}</code>`, parse_mode: 'HTML' })
                });
                alert('Request sent!');
                closeModal('vipPurchaseModal');
            } catch { alert('Failed'); } finally {
                btn.querySelector('span').style.display = 'inline';
                btn.querySelector('.spinner').style.display = 'none';
                btn.disabled = false;
            }
        });

        function copyPaymentNumber() {
            navigator.clipboard.writeText('01925723245');
            alert('Copied!');
        }

        // --- INIT ---
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('preloader').style.display = 'none';
                document.querySelector('.container').style.display = 'block';
            }, 1000);

            els.userTgId.value = tg.initDataUnsafe.user.id;
            els.buyVipBtn.addEventListener('click', () => showModal('vipPurchaseModal'));
            loadVipPackages();
            updateVIPStatus();
        });

        function showModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    </script>
</body>
</html>
