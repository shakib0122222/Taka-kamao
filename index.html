<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP Admin Panel - Taka Income Pro</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { 
            --primary: #ff6347; 
            --gold: #ffd700; 
            --light-bg: #f8f9fa;
            --dark-bg: #333;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #fd7e14;
            --info: #17a2b8;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #ff6347, #e5533d); 
            margin: 0; 
            padding: 10px; 
            color: #333; 
            min-height: 100vh;
            font-size: 14px;
        }
        
        .container { 
            max-width: 100%; 
            margin: auto; 
            background: white; 
            border-radius: 15px; 
            padding: 15px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        h1 { 
            color: var(--primary); 
            font-weight: 800;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stats {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 10px;
            text-align: center;
            min-width: 80px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 0.7rem;
            color: #666;
        }
        
        .tab { 
            display: flex; 
            overflow-x: auto;
            border-radius: 10px; 
            background: #f8f9fa; 
            margin-bottom: 15px; 
            padding: 5px;
            scrollbar-width: none;
            gap: 5px;
        }
        
        .tab::-webkit-scrollbar {
            display: none;
        }
        
        .tab button { 
            background: none; 
            border: none; 
            padding: 12px 15px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.3s; 
            border-radius: 8px; 
            white-space: nowrap;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
            flex: 1;
            justify-content: center;
        }
        
        .tab button.active { 
            background: var(--primary); 
            color: white; 
            box-shadow: 0 2px 8px rgba(255,99,71,0.3); 
        }
        
        .tabcontent { 
            display: none; 
            animation: fadeIn 0.5s; 
        }
        
        .tabcontent.active { 
            display: block; 
        }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            color: var(--primary);
            font-size: 1.1rem;
        }
        
        .card { 
            background: white; 
            border-radius: 12px; 
            overflow: hidden; 
            box-shadow: 0 3px 10px rgba(0,0,0,0.08); 
            margin-bottom: 15px;
            border: 1px solid #f0f0f0;
        }
        
        .card-header {
            padding: 12px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-body {
            padding: 15px;
        }
        
        .user-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .user-name {
            font-weight: bold;
            font-size: 1rem;
        }
        
        .user-details {
            font-size: 0.8rem;
            color: #666;
        }
        
        .package-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 10px 0;
        }
        
        .package-name {
            font-weight: bold;
            color: var(--primary);
        }
        
        .package-specs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .spec {
            background: #f0f8ff;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        .request-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 10px 0;
        }
        
        .txid {
            font-family: monospace;
            font-size: 0.8rem;
            background: #f5f5f5;
            padding: 8px;
            border-radius: 6px;
            word-break: break-all;
            border: 1px dashed #ddd;
        }
        
        .date {
            font-size: 0.8rem;
            color: #666;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
            margin-top: 5px;
        }
        
        .status-pending { 
            background: #fff3cd;
            color: #856404;
        }
        
        .status-approved { 
            background: #d4edda;
            color: #155724;
        }
        
        .status-rejected { 
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-expired { 
            background: #e2e3e5;
            color: #383d41;
        }
        
        .status-banned { 
            background: #dc3545;
            color: white;
        }
        
        .vip-badge {
            background: var(--gold);
            color: black;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }
        
        .btn { 
            padding: 8px 12px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.3s; 
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            flex: 1;
            justify-content: center;
        }
        
        .btn-sm {
            padding: 6px 10px;
            font-size: 0.75rem;
            flex: 0;
        }
        
        .btn-approve { 
            background: var(--success); 
            color: white; 
        }
        
        .btn-approve:hover { 
            background: #218838; 
            transform: translateY(-2px); 
        }
        
        .btn-reject { 
            background: var(--danger); 
            color: white; 
        }
        
        .btn-reject:hover { 
            background: #c82333; 
            transform: translateY(-2px); 
        }
        
        .btn-edit { 
            background: var(--gold); 
            color: black; 
        }
        
        .btn-edit:hover { 
            background: #e6c200; 
        }
        
        .btn-info { 
            background: var(--info); 
            color: white; 
        }
        
        .btn-info:hover { 
            background: #138496; 
        }
        
        .btn-sync { 
            background: var(--warning); 
            color: white; 
        }
        
        .btn-sync:hover { 
            background: #e0a800; 
        }
        
        .btn-ban { 
            background: var(--danger); 
            color: white; 
        }
        
        .btn-ban:hover { 
            background: #c82333; 
        }
        
        .btn-unban { 
            background: var(--success); 
            color: white; 
        }
        
        .btn-unban:hover { 
            background: #218838; 
        }
        
        .form-group { 
            margin: 15px 0; 
            display: flex; 
            flex-direction: column;
            gap: 10px; 
        }
        
        label { 
            font-weight: 600; 
            color: var(--primary); 
        }
        
        input, select { 
            padding: 12px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            width: 100%;
            font-size: 1rem;
        }
        
        .package-item { 
            display: flex; 
            flex-direction: column;
            padding: 15px; 
            background: #f8f9fa; 
            border-radius: 10px; 
            margin: 10px 0; 
            gap: 10px;
        }
        
        .package-info {
            flex: 1;
        }
        
        .package-actions {
            display: flex;
            gap: 8px;
        }
        
        .no-data { 
            text-align: center; 
            padding: 30px; 
            color: #6c757d; 
            font-style: italic; 
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        #notification { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            padding: 15px 20px; 
            background: var(--success); 
            color: white; 
            border-radius: 8px; 
            display: none; 
            z-index: 1000; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 300px;
        }
        
        .expiry-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin: 10px 0;
        }
        
        .expiry-date {
            font-weight: bold;
            color: var(--primary);
        }
        
        .days-left {
            font-size: 0.8rem;
            color: #666;
        }
        
        .search-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .search-box {
            flex: 1;
            min-width: 200px;
            position: relative;
        }
        
        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        
        .search-box input {
            padding-left: 35px;
        }
        
        .filter-select {
            min-width: 150px;
        }

        .user-earning {
            font-weight: bold;
            color: var(--primary);
            font-size: 0.9rem;
        }

        .join-date {
            font-size: 0.8rem;
            color: #666;
        }
        
        /* Desktop styles */
        @media (min-width: 768px) {
            body {
                padding: 20px;
                font-size: 16px;
            }
            
            .container {
                padding: 25px;
                max-width: 1200px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .tab button {
                padding: 14px 20px;
                font-size: 0.9rem;
                flex: 0;
            }
            
            .card-body {
                padding: 20px;
            }
            
            .user-info, .package-details, .request-details, .expiry-info {
                flex-direction: row;
                align-items: center;
                gap: 15px;
            }
            
            .package-specs {
                gap: 15px;
            }
            
            .actions {
                justify-content: flex-start;
            }
            
            .btn {
                flex: 0;
                padding: 10px 16px;
                font-size: 0.85rem;
            }
            
            .form-group {
                flex-direction: row;
                align-items: center;
            }
            
            label {
                min-width: 120px;
            }
            
            .package-item {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
            }
            
            .package-actions {
                width: auto;
            }
        }
        
        @media (min-width: 992px) {
            .stats {
                gap: 15px;
            }
            
            .stat-card {
                min-width: 100px;
                padding: 12px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fa-solid fa-crown"></i> VIP Admin Panel</h1>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="pending-count">0</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="active-count">0</div>
                    <div class="stat-label">Active VIP</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-users-count">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-earnings">৳0</div>
                    <div class="stat-label">Total Earnings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-count">0</div>
                    <div class="stat-label">Total Requests</div>
                </div>
            </div>
        </div>
        
        <div id="notification"></div>
        
        <div class="tab">
            <button class="tablinks active" onclick="openTab(event, 'requests')"><i class="fa-solid fa-clock"></i> Requests</button>
            <button class="tablinks" onclick="openTab(event, 'active')"><i class="fa-solid fa-users"></i> Active VIP</button>
            <button class="tablinks" onclick="openTab(event, 'users')"><i class="fa-solid fa-user-friends"></i> Users</button>
            <button class="tablinks" onclick="openTab(event, 'packages')"><i class="fa-solid fa-box"></i> Packages</button>
            <button class="tablinks" onclick="openTab(event, 'history')"><i class="fa-solid fa-history"></i> History</button>
        </div>

        <div id="requests" class="tabcontent active">
            <div class="section-title">
                <i class="fa-solid fa-list"></i>
                <h3>Pending VIP Requests</h3>
            </div>
            
            <div class="search-filter">
                <div class="search-box">
                    <i class="fa-solid fa-search"></i>
                    <input type="text" id="request-search" placeholder="Search by name, username or TxID...">
                </div>
                <select class="filter-select" id="package-filter">
                    <option value="">All Packages</option>
                </select>
            </div>
            
            <div id="request-list"></div>
        </div>

        <div id="packages" class="tabcontent">
            <div class="section-title">
                <i class="fa-solid fa-cog"></i>
                <h3>Manage VIP Packages</h3>
            </div>
            
            <div class="card">
                <div class="card-header">
                    Sync Default Packages
                    <button class="btn btn-sync btn-sm" onclick="syncDefaultPackages()">
                        <i class="fa-solid fa-sync-alt"></i> Sync Now
                    </button>
                </div>
                <div class="card-body">
                    <p>Click "Sync Now" to load default VIP packages from app config into Firebase. This ensures correct validity days for all packages.</p>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">Add/Edit Package</div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Package Name</label>
                        <input type="text" id="pkg-name" placeholder="VIP Basic">
                    </div>
                    <div class="form-group">
                        <label>Price (BDT)</label>
                        <input type="number" id="pkg-price" placeholder="100">
                    </div>
                    <div class="form-group">
                        <label>Daily Ads Limit</label>
                        <input type="number" id="pkg-ads" placeholder="50">
                    </div>
                    <div class="form-group">
                        <label>Validity Days</label>
                        <input type="number" id="pkg-days" placeholder="7">
                    </div>
                    <div class="actions">
                        <button class="btn btn-approve" onclick="addOrUpdatePackage()">
                            <i class="fa-solid fa-plus"></i> Add Package
                        </button>
                        <button class="btn btn-info" onclick="clearPackageForm()">
                            <i class="fa-solid fa-times"></i> Clear
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="package-list"></div>
        </div>

        <div id="active" class="tabcontent">
            <div class="section-title">
                <i class="fa-solid fa-star"></i>
                <h3>Active VIP Members</h3>
            </div>
            
            <div class="search-filter">
                <div class="search-box">
                    <i class="fa-solid fa-search"></i>
                    <input type="text" id="active-search" placeholder="Search active VIPs...">
                </div>
                <select class="filter-select" id="status-filter">
                    <option value="all">All Status</option>
                    <option value="active">Active</option>
                    <option value="expiring">Expiring Soon</option>
                    <option value="expired">Expired</option>
                </select>
            </div>
            
            <div id="active-list"></div>
        </div>

        <div id="users" class="tabcontent">
            <div class="section-title">
                <i class="fa-solid fa-user-friends"></i>
                <h3>All Users</h3>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                        <div>
                            <strong>Total Users:</strong> <span id="user-total-display">0</span>
                        </div>
                        <div>
                            <strong>Total Earnings:</strong> <span id="total-earnings-display">৳0</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="search-filter">
                <div class="search-box">
                    <i class="fa-solid fa-search"></i>
                    <input type="text" id="user-search" placeholder="Search users by name or username...">
                </div>
                <select class="filter-select" id="user-vip-filter">
                    <option value="all">All Users</option>
                    <option value="vip">VIP Users</option>
                    <option value="non-vip">Non-VIP</option>
                    <option value="banned">Banned Users</option>
                </select>
            </div>
            
            <div id="user-list"></div>
        </div>
        
        <div id="history" class="tabcontent">
            <div class="section-title">
                <i class="fa-solid fa-history"></i>
                <h3>VIP Request History</h3>
            </div>
            
            <div class="search-filter">
                <div class="search-box">
                    <i class="fa-solid fa-search"></i>
                    <input type="text" id="history-search" placeholder="Search history...">
                </div>
                <select class="filter-select" id="history-status-filter">
                    <option value="all">All Status</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                </select>
            </div>
            
            <div id="history-list"></div>
        </div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCWvaqpi3LvNDeZpDBunnDwU392ZH_FY8M",
            authDomain: "st-project-taka-kamao.firebaseapp.com",
            databaseURL: "https://st-project-taka-kamao-default-rtdb.firebaseio.com",
            projectId: "st-project-taka-kamao",
            storageBucket: "st-project-taka-kamao.firebasestorage.app",
            messagingSenderId: "151575920757",
            appId: "1:151575920757:web:5dc8e0e2a0856f5a76b83c"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database().ref();

        let currentPackages = [];
        let editingPackageId = null;
        let allUsersData = {};

        // Fixed calculation to avoid timezone/DST issues by normalizing to midnight UTC
        function calculateDaysLeft(expiryDate) {
            const today = new Date();
            today.setUTCHours(0, 0, 0, 0);
            const exp = new Date(expiryDate);
            exp.setUTCHours(0, 0, 0, 0);
            const diffTime = exp.getTime() - today.getTime();
            if (diffTime <= 0) return 0;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        // Default packages from client config
        const defaultPackages = [
            { id: 'vip_50', name: 'VIP Starter', price: 50, dailyAds: 15, validityDays: 5 },
            { id: 'vip_100', name: 'VIP Basic', price: 100, dailyAds: 25, validityDays: 7 },
            { id: 'vip_200', name: 'VIP Pro', price: 200, dailyAds: 35, validityDays: 10 },
            { id: 'vip_500', name: 'VIP Gold', price: 500, dailyAds: 50, validityDays: 30 },
            { id: 'vip_1000', name: 'VIP Platinum', price: 1000, dailyAds: 100, validityDays: 90 }
        ];

        function showNotification(msg, type = 'success') {
            const notif = document.getElementById('notification');
            notif.textContent = msg;
            notif.style.background = type === 'success' ? '#28a745' : '#dc3545';
            notif.style.display = 'block';
            setTimeout(() => notif.style.display = 'none', 3000);
        }

        function openTab(evt, tabName) {
            document.querySelectorAll('.tabcontent').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tablinks').forEach(b => b.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
            if (tabName === 'packages') loadPackages();
            if (tabName === 'requests') loadRequests();
            if (tabName === 'active') loadActiveVIPs();
            if (tabName === 'users') loadUsers();
            if (tabName === 'history') loadVIPHistory();
        }

        // Update stats counters
        function updateStats() {
            // Pending requests count
            db.child('vip_requests').once('value').then(snapshot => {
                const data = snapshot.val() || {};
                let pendingCount = 0;
                Object.values(data).forEach(req => {
                    if (req.status === 'pending') pendingCount++;
                });
                document.getElementById('pending-count').textContent = pendingCount;
            });
            
            // Active VIPs count
            db.child('vip_users').once('value').then(snapshot => {
                const data = snapshot.val() || {};
                let activeCount = 0;
                Object.values(data).forEach(vip => {
                    if (vip.active && calculateDaysLeft(vip.expiry) > 0) activeCount++;
                });
                document.getElementById('active-count').textContent = activeCount;
            });
            
            // Total users count and total earnings
            db.child('users').once('value').then(snapshot => {
                const data = snapshot.val() || {};
                const totalUsers = Object.keys(data).length;
                let totalEarnings = 0;
                Object.values(data).forEach(user => {
                    if (user.totalEarning) totalEarnings += parseFloat(user.totalEarning) || 0;
                });
                document.getElementById('total-users-count').textContent = totalUsers;
                document.getElementById('total-earnings').textContent = `৳${totalEarnings.toFixed(2)}`;
            });
            
            // Total requests count
            db.child('vip_requests').once('value').then(snapshot => {
                const data = snapshot.val() || {};
                document.getElementById('total-count').textContent = Object.keys(data).length;
            });
        }

        // Sync Default Packages to Firebase
        async function syncDefaultPackages() {
            if (!confirm('Sync default packages to Firebase? This will overwrite existing packages.')) return;
            try {
                const updates = {};
                defaultPackages.forEach(pkg => {
                    updates[`vip_packages/${pkg.id}`] = pkg;
                });
                await db.child('vip_packages').update(updates);
                showNotification('Default packages synced successfully!');
                loadPackages(); // Reload to show updated
            } catch (e) {
                console.error(e);
                showNotification('Error syncing packages', 'error');
            }
        }

        // Load VIP Requests
        function loadRequests() {
            const list = document.getElementById('request-list');
            list.innerHTML = '';
            db.child('vip_requests').on('value', (snapshot) => {
                const data = snapshot.val() || {};
                let hasPending = false;
                
                Object.entries(data).forEach(([userId, req]) => {
                    if (req.status !== 'pending') return;
                    hasPending = true;
                    
                    // Always use default packages for consistency
                    const pkg = defaultPackages.find(p => p.id === req.packageId) || {
                        name: req.packageId.replace('vip_', 'Unknown'),
                        dailyAds: 'N/A',
                        validityDays: 7 // Safe default
                    };
                    
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <div class="card-body">
                            <div class="user-info">
                                <div>
                                    <div class="user-name">${req.name || 'N/A'}</div>
                                    <div class="user-details">@${req.username || 'N/A'} | ID: ${req.userId}</div>
                                </div>
                                <span class="status status-pending">Pending</span>
                            </div>
                            
                            <div class="package-details">
                                <div class="package-name">${pkg.name} - ৳${req.price}</div>
                                <div class="package-specs">
                                    <div class="spec"><i class="fa-solid fa-ad"></i> ${pkg.dailyAds} Ads/Day</div>
                                    <div class="spec"><i class="fa-solid fa-calendar"></i> ${pkg.validityDays} Days</div>
                                </div>
                            </div>
                            
                            <div class="request-details">
                                <div>
                                    <div class="txid">${req.txid}</div>
                                    <div class="date"><i class="fa-solid fa-clock"></i> ${new Date(req.timestamp).toLocaleString()}</div>
                                </div>
                            </div>
                            
                            <div class="actions">
                                <button class="btn btn-approve" onclick="approveVIP('${userId}', '${req.packageId}', ${req.price}, ${pkg.validityDays})">
                                    <i class="fa-solid fa-check"></i> Approve
                                </button>
                                <button class="btn btn-reject" onclick="rejectVIP('${userId}')">
                                    <i class="fa-solid fa-times"></i> Reject
                                </button>
                                <button class="btn btn-info btn-sm" onclick="viewUserDetails('${userId}')">
                                    <i class="fa-solid fa-eye"></i> Details
                                </button>
                            </div>
                        </div>
                    `;
                    list.appendChild(card);
                });
                
                if (!hasPending) {
                    list.innerHTML = '<div class="no-data"><i class="fa-solid fa-inbox"></i> No pending requests</div>';
                }
                
                updateStats();
            });
        }

        // Approve VIP
        async function approveVIP(userId, packageId, price, validityDays) {
            if (!confirm('Approve this VIP request?')) return;
            
            const startDate = new Date();
            startDate.setUTCHours(0, 0, 0, 0); // Normalize to UTC midnight
            const expiryDate = new Date(startDate);
            expiryDate.setUTCDate(expiryDate.getUTCDate() + validityDays);
            expiryDate.setUTCHours(23, 59, 59, 999); // End of the day in UTC
            
            try {
                // Get user details from request
                const userReq = await db.child(`vip_requests/${userId}`).once('value');
                const userData = userReq.val();
                
                await db.child(`vip_users/${userId}`).set({
                    active: true,
                    packageId: packageId,
                    price: price,
                    start: startDate.toISOString(),
                    expiry: expiryDate.toISOString(),
                    name: userData.name,
                    username: userData.username,
                    userId: userData.userId,
                    approvedAt: new Date().toISOString()
                });
                
                await db.child(`vip_requests/${userId}`).update({ 
                    status: 'approved',
                    approvedAt: new Date().toISOString(),
                    expiry: expiryDate.toISOString()
                });
                
                showNotification('VIP approved successfully!');
            } catch (e) {
                console.error(e);
                showNotification('Error approving VIP', 'error');
            }
        }

        // Reject VIP
        async function rejectVIP(userId) {
            if (!confirm('Reject this request?')) return;
            try {
                await db.child(`vip_requests/${userId}`).update({ 
                    status: 'rejected',
                    rejectedAt: new Date().toISOString()
                });
                showNotification('Request rejected.');
            } catch (e) {
                showNotification('Error rejecting request', 'error');
            }
        }

        // View User Details
        function viewUserDetails(userId) {
            alert(`User ID: ${userId}\nMore details would be shown here in a real application.`);
        }

        // Load Packages
        function loadPackages() {
            const list = document.getElementById('package-list');
            list.innerHTML = '';
            db.child('vip_packages').once('value').then((snapshot) => {
                const packagesData = snapshot.val();
                if (packagesData) {
                    currentPackages = Object.values(packagesData);
                } else {
                    currentPackages = [...defaultPackages];
                }
                
                if (currentPackages.length === 0) {
                    list.innerHTML = '<div class="no-data"><i class="fa-solid fa-box-open"></i> No packages found</div>';
                    return;
                }
                
                currentPackages.forEach(pkg => {
                    const item = document.createElement('div');
                    item.className = 'package-item';
                    item.innerHTML = `
                        <div class="package-info">
                            <strong>${pkg.name}</strong>
                            <div class="package-specs">
                                <div class="spec">৳${pkg.price}</div>
                                <div class="spec"><i class="fa-solid fa-ad"></i> ${pkg.dailyAds} Ads/Day</div>
                                <div class="spec"><i class="fa-solid fa-calendar"></i> ${pkg.validityDays} Days</div>
                            </div>
                        </div>
                        <div class="package-actions">
                            <button class="btn btn-edit btn-sm" onclick="editPackage('${pkg.id}')">
                                <i class="fa-solid fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-reject btn-sm" onclick="deletePackage('${pkg.id}')">
                                <i class="fa-solid fa-trash"></i> Delete
                            </button>
                        </div>
                    `;
                    list.appendChild(item);
                });
            });
        }

        // Add/Update Package
        async function addOrUpdatePackage() {
            const name = document.getElementById('pkg-name').value;
            const price = parseInt(document.getElementById('pkg-price').value);
            const ads = parseInt(document.getElementById('pkg-ads').value);
            const days = parseInt(document.getElementById('pkg-days').value);
            
            if (!name || !price || !ads || !days) return showNotification('Fill all fields', 'error');
            
            const pkgId = `vip_${price}`;
            try {
                await db.child(`vip_packages/${pkgId}`).set({ 
                    id: pkgId, 
                    name, 
                    price, 
                    dailyAds: ads, 
                    validityDays: days 
                });
                
                showNotification(editingPackageId ? 'Package updated!' : 'Package added!');
                loadPackages();
                clearPackageForm();
            } catch (e) {
                showNotification('Error saving package', 'error');
            }
        }

        // Edit Package (Pre-fill form)
        function editPackage(pkgId) {
            const pkg = currentPackages.find(p => p.id === pkgId);
            if (pkg) {
                document.getElementById('pkg-name').value = pkg.name;
                document.getElementById('pkg-price').value = pkg.price;
                document.getElementById('pkg-ads').value = pkg.dailyAds;
                document.getElementById('pkg-days').value = pkg.validityDays;
                editingPackageId = pkgId;
                
                // Change button text
                const btn = document.querySelector('#packages .btn-approve');
                btn.innerHTML = '<i class="fa-solid fa-save"></i> Update Package';
            }
        }

        // Clear package form
        function clearPackageForm() {
            document.getElementById('pkg-name').value = '';
            document.getElementById('pkg-price').value = '';
            document.getElementById('pkg-ads').value = '';
            document.getElementById('pkg-days').value = '';
            editingPackageId = null;
            
            // Reset button text
            const btn = document.querySelector('#packages .btn-approve');
            btn.innerHTML = '<i class="fa-solid fa-plus"></i> Add Package';
        }

        // Delete Package
        async function deletePackage(pkgId) {
            if (!confirm('Delete this package?')) return;
            try {
                await db.child(`vip_packages/${pkgId}`).remove();
                showNotification('Package deleted!');
                loadPackages();
            } catch (e) {
                showNotification('Error deleting package', 'error');
            }
        }

        // Load Active VIPs
        function loadActiveVIPs() {
            const list = document.getElementById('active-list');
            list.innerHTML = '';
            db.child('vip_users').on('value', (snapshot) => {
                const data = snapshot.val() || {};
                let hasActive = false;
                
                Object.entries(data).forEach(([userId, vip]) => {
                    if (!vip.active) return;
                    
                    const daysLeft = calculateDaysLeft(vip.expiry);
                    
                    let status = 'active';
                    let statusClass = 'status-approved';
                    let statusText = 'Active';
                    
                    if (daysLeft <= 0) {
                        status = 'expired';
                        statusClass = 'status-expired';
                        statusText = 'Expired';
                    } else if (daysLeft <= 3) {
                        status = 'expiring';
                        statusClass = 'status-pending';
                        statusText = 'Expiring Soon';
                    }
                    
                    hasActive = true;
                    
                    // Use default packages for display
                    const pkg = defaultPackages.find(p => p.id === vip.packageId) || {
                        name: vip.packageId.replace('vip_', 'Unknown')
                    };
                    
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <div class="card-body">
                            <div class="user-info">
                                <div>
                                    <div class="user-name">${vip.name || 'N/A'}</div>
                                    <div class="user-details">@${vip.username || 'N/A'} | ID: ${userId}</div>
                                </div>
                                <span class="status ${statusClass}">${statusText}</span>
                            </div>
                            
                            <div class="package-details">
                                <div class="package-name">${pkg.name} - ৳${vip.price}</div>
                            </div>
                            
                            <div class="expiry-info">
                                <div>
                                    <div class="expiry-date">Expires: ${new Date(vip.expiry).toLocaleDateString()}</div>
                                    <div class="days-left">${daysLeft > 0 ? `${daysLeft} days left` : 'Expired'}</div>
                                </div>
                            </div>
                            
                            <div class="actions">
                                <button class="btn btn-reject" onclick="deactivateVIP('${userId}')">
                                    <i class="fa-solid fa-stop"></i> Deactivate
                                </button>
                                <button class="btn btn-info btn-sm" onclick="extendVIP('${userId}')">
                                    <i class="fa-solid fa-calendar-plus"></i> Extend
                                </button>
                                <button class="btn btn-info btn-sm" onclick="viewUserDetails('${userId}')">
                                    <i class="fa-solid fa-eye"></i> Details
                                </button>
                            </div>
                        </div>
                    `;
                    list.appendChild(card);
                });
                
                if (!hasActive) {
                    list.innerHTML = '<div class="no-data"><i class="fa-solid fa-users"></i> No active VIPs</div>';
                }
                
                updateStats();
            });
        }

        // Extend VIP
        function extendVIP(userId) {
            const days = prompt('Extend VIP by how many days?', '7');
            if (days && !isNaN(days)) {
                db.child(`vip_users/${userId}`).once('value').then(snapshot => {
                    const vip = snapshot.val();
                    const currentExpiry = new Date(vip.expiry);
                    const newExpiry = new Date(currentExpiry);
                    newExpiry.setUTCDate(newExpiry.getUTCDate() + parseInt(days));
                    newExpiry.setUTCHours(23, 59, 59, 999); // End of the day in UTC
                    
                    db.child(`vip_users/${userId}/expiry`).set(newExpiry.toISOString())
                        .then(() => showNotification(`VIP extended by ${days} days`))
                        .catch(() => showNotification('Error extending VIP', 'error'));
                });
            }
        }

        // Deactivate VIP
        async function deactivateVIP(userId) {
            if (!confirm('Deactivate this VIP?')) return;
            try {
                await db.child(`vip_users/${userId}`).update({ active: false });
                showNotification('VIP deactivated!');
            } catch (e) {
                showNotification('Error deactivating VIP', 'error');
            }
        }

        // Load Users
        function loadUsers() {
            const list = document.getElementById('user-list');
            list.innerHTML = '';
            db.child('users').on('value', (snapshot) => {
                const data = snapshot.val() || {};
                allUsersData = data;
                let filteredUsers = Object.entries(data).map(([userId, user]) => ({ userId, ...user }));

                // Apply filters
                const searchTerm = document.getElementById('user-search').value.toLowerCase();
                const vipFilter = document.getElementById('user-vip-filter').value;

                if (searchTerm) {
                    filteredUsers = filteredUsers.filter(u => 
                        (u.name || '').toLowerCase().includes(searchTerm) ||
                        (u.username || '').toLowerCase().includes(searchTerm)
                    );
                }

                if (vipFilter === 'vip') {
                    // Get VIP users
                    db.child('vip_users').once('value').then(vipSnapshot => {
                        const vipData = vipSnapshot.val() || {};
                        const vipIds = Object.keys(vipData).filter(id => vipData[id].active && calculateDaysLeft(vipData[id].expiry) > 0);
                        filteredUsers = filteredUsers.filter(u => vipIds.includes(u.userId));
                        renderUserList(filteredUsers);
                    });
                    return;
                } else if (vipFilter === 'non-vip') {
                    db.child('vip_users').once('value').then(vipSnapshot => {
                        const vipData = vipSnapshot.val() || {};
                        const vipIds = Object.keys(vipData).filter(id => vipData[id].active && calculateDaysLeft(vipData[id].expiry) > 0);
                        filteredUsers = filteredUsers.filter(u => !vipIds.includes(u.userId));
                        renderUserList(filteredUsers);
                    });
                    return;
                } else if (vipFilter === 'banned') {
                    filteredUsers = filteredUsers.filter(u => u.banned === true);
                    renderUserList(filteredUsers);
                    return;
                }

                renderUserList(filteredUsers);
            });
        }

        function renderUserList(users) {
            const list = document.getElementById('user-list');
            list.innerHTML = '';

            if (users.length === 0) {
                list.innerHTML = '<div class="no-data"><i class="fa-solid fa-users"></i> No users found</div>';
                return;
            }

            // Get VIP status
            db.child('vip_users').once('value').then(vipSnapshot => {
                const vipData = vipSnapshot.val() || {};
                const vipIds = Object.keys(vipData).filter(id => vipData[id].active && calculateDaysLeft(vipData[id].expiry) > 0);

                users.forEach(userObj => {
                    const { userId, ...user } = userObj;
                    const isVIP = vipIds.includes(userId);
                    const isBanned = user.banned || false;
                    const joinDate = user.joinDate ? new Date(user.joinDate).toLocaleDateString() : 'N/A';
                    const totalEarning = user.totalEarning ? `৳${parseFloat(user.totalEarning).toFixed(2)}` : '৳0.00';
                    const balance = user.balance ? `৳${parseFloat(user.balance).toFixed(2)}` : '৳0.00';

                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <div class="card-body">
                            <div class="user-info">
                                <div>
                                    <div class="user-name">${user.name || 'N/A'}${isVIP ? '<span class="vip-badge">VIP</span>' : ''}</div>
                                    <div class="user-details">@${user.username || 'N/A'} | ID: ${userId}</div>
                                    <div class="join-date"><i class="fa-solid fa-calendar"></i> Joined: ${joinDate}</div>
                                    <div class="user-earning"><i class="fa-solid fa-money-bill"></i> Earnings: ${totalEarning}</div>
                                    <div class="user-earning"><i class="fa-solid fa-wallet"></i> Balance: ${balance}</div>
                                </div>
                                ${isBanned ? '<span class="status status-banned">Banned</span>' : ''}
                            </div>
                            
                            <div class="actions">
                                ${isBanned ? 
                                    `<button class="btn btn-unban btn-sm" onclick="unbanUser('${userId}')">
                                        <i class="fa-solid fa-unlock"></i> Unban
                                    </button>` :
                                    `<button class="btn btn-ban btn-sm" onclick="banUser('${userId}')">
                                        <i class="fa-solid fa-ban"></i> Ban
                                    </button>`
                                }
                                <button class="btn btn-approve btn-sm" onclick="addBalance('${userId}')">
                                    <i class="fa-solid fa-plus"></i> Add Balance
                                </button>
                                <button class="btn btn-reject btn-sm" onclick="deductBalance('${userId}')">
                                    <i class="fa-solid fa-minus"></i> Deduct Balance
                                </button>
                                <button class="btn btn-info btn-sm" onclick="viewUserDetails('${userId}')">
                                    <i class="fa-solid fa-eye"></i> Details
                                </button>
                            </div>
                        </div>
                    `;
                    list.appendChild(card);
                });

                // Update totals display
                const totalUsers = users.length;
                const totalEarnings = users.reduce((sum, userObj) => {
                    const { ...user } = userObj;
                    return sum + (parseFloat(user.totalEarning) || 0);
                }, 0);
                document.getElementById('user-total-display').textContent = totalUsers;
                document.getElementById('total-earnings-display').textContent = `৳${totalEarnings.toFixed(2)}`;

                updateStats();
            });
        }

        // Add Balance to User
        async function addBalance(userId) {
            const amount = prompt('Enter amount to add to balance (BDT):');
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                try {
                    const userRef = db.child(`users/${userId}`);
                    const snapshot = await userRef.once('value');
                    const user = snapshot.val();
                    const currentBalance = user.balance || 0;
                    const newBalance = currentBalance + parseFloat(amount);
                    await userRef.update({ balance: newBalance });
                    showNotification(`Added ৳${parseFloat(amount).toFixed(2)} to balance. New balance: ৳${newBalance.toFixed(2)}`);
                    loadUsers(); // Reload to update display
                } catch (e) {
                    console.error(e);
                    showNotification('Error adding balance', 'error');
                }
            } else if (amount) {
                showNotification('Invalid amount. Please enter a positive number.', 'error');
            }
        }

        // Deduct Balance from User
        async function deductBalance(userId) {
            const amountStr = prompt('Enter amount to deduct from balance (BDT):');
            if (amountStr && !isNaN(amountStr) && parseFloat(amountStr) > 0) {
                const deductAmount = parseFloat(amountStr);
                try {
                    const userRef = db.child(`users/${userId}`);
                    const snapshot = await userRef.once('value');
                    const user = snapshot.val();
                    let currentRefer = user.referBalance ? parseFloat(user.referBalance) : 0;
                    let currentBalance = user.balance ? parseFloat(user.balance) : 0;
                    let remaining = deductAmount;

                    // First, deduct from refer balance if available
                    if (currentRefer > 0) {
                        if (remaining >= currentRefer) {
                            remaining -= currentRefer;
                            await userRef.update({ referBalance: 0 });
                        } else {
                            const newRefer = currentRefer - remaining;
                            await userRef.update({ referBalance: newRefer });
                            remaining = 0;
                        }
                    }

                    // Then, deduct remaining from main balance
                    if (remaining > 0) {
                        if (remaining > currentBalance) {
                            showNotification('Cannot deduct more than available balances.', 'error');
                            return;
                        }
                        const newBalance = currentBalance - remaining;
                        await userRef.update({ balance: newBalance });
                    }

                    // Reload current data for notification
                    const updatedSnapshot = await userRef.once('value');
                    const updatedUser = updatedSnapshot.val();
                    const finalRefer = updatedUser.referBalance ? parseFloat(updatedUser.referBalance) : 0;
                    const finalBalance = updatedUser.balance ? parseFloat(updatedUser.balance) : 0;

                    showNotification(`Deducted ৳${deductAmount.toFixed(2)}. New refer balance: ৳${finalRefer.toFixed(2)}, New main balance: ৳${finalBalance.toFixed(2)}`);
                    loadUsers(); // Reload to update display
                } catch (e) {
                    console.error(e);
                    showNotification('Error deducting balance', 'error');
                }
            } else if (amountStr) {
                showNotification('Invalid amount. Please enter a positive number.', 'error');
            }
        }

        // Ban User
        async function banUser(userId) {
            if (!confirm('Ban this user?')) return;
            try {
                await db.child(`users/${userId}/banned`).set(true);
                showNotification('User banned successfully!');
                loadUsers(); // Reload to update
            } catch (e) {
                showNotification('Error banning user', 'error');
            }
        }

        // Unban User
        async function unbanUser(userId) {
            if (!confirm('Unban this user?')) return;
            try {
                await db.child(`users/${userId}/banned`).set(false);
                showNotification('User unbanned successfully!');
                loadUsers(); // Reload to update
            } catch (e) {
                showNotification('Error unbanning user', 'error');
            }
        }

        // Load VIP History
        function loadVIPHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            db.child('vip_requests').on('value', (snapshot) => {
                const data = snapshot.val() || {};
                let hasHistory = false;
                
                Object.entries(data).forEach(([userId, req]) => {
                    if (req.status === 'pending') return;
                    hasHistory = true;
                    
                    // Use default for display
                    const pkg = defaultPackages.find(p => p.id === req.packageId) || {
                        name: req.packageId.replace('vip_', 'Unknown')
                    };
                    
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <div class="card-body">
                            <div class="user-info">
                                <div>
                                    <div class="user-name">${req.name || 'N/A'}</div>
                                    <div class="user-details">@${req.username || 'N/A'} | ID: ${req.userId}</div>
                                </div>
                                <span class="status ${req.status === 'approved' ? 'status-approved' : 'status-rejected'}">
                                    ${req.status.charAt(0).toUpperCase() + req.status.slice(1)}
                                </span>
                            </div>
                            
                            <div class="package-details">
                                <div class="package-name">${pkg.name} - ৳${req.price}</div>
                            </div>
                            
                            <div class="request-details">
                                <div>
                                    <div class="txid">${req.txid}</div>
                                    <div class="date"><i class="fa-solid fa-clock"></i> ${new Date(req.timestamp).toLocaleString()}</div>
                                    ${req.approvedAt ? 
                                        `<div class="date"><i class="fa-solid fa-check"></i> Approved: ${new Date(req.approvedAt).toLocaleString()}</div>` : 
                                        ''}
                                    ${req.rejectedAt ? 
                                        `<div class="date"><i class="fa-solid fa-times"></i> Rejected: ${new Date(req.rejectedAt).toLocaleString()}</div>` : 
                                        ''}
                                </div>
                            </div>
                        </div>
                    `;
                    list.appendChild(card);
                });
                
                if (!hasHistory) {
                    list.innerHTML = '<div class="no-data"><i class="fa-solid fa-history"></i> No VIP history</div>';
                }
            });
        }

        // Event listeners for filters
        document.addEventListener('DOMContentLoaded', () => {
            // User search and filter
            document.getElementById('user-search').addEventListener('input', loadUsers);
            document.getElementById('user-vip-filter').addEventListener('change', loadUsers);
        });

        // Initial Load
        loadPackages();
        loadRequests();
        updateStats();
    </script>
</body>
</html>
